<html>
<head>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <style>

        .bubble {
            background-image: linear-gradient(bottom, rgb(210, 244, 254) 25%, rgb(149, 194, 253) 100%);
            background-image: -o-linear-gradient(bottom, rgb(210, 244, 254) 25%, rgb(149, 194, 253) 100%);
            background-image: -moz-linear-gradient(bottom, rgb(210, 244, 254) 25%, rgb(149, 194, 253) 100%);
            background-image: -webkit-linear-gradient(bottom, rgb(210, 244, 254) 25%, rgb(149, 194, 253) 100%);
            background-image: -ms-linear-gradient(bottom, rgb(210, 244, 254) 25%, rgb(149, 194, 253) 100%);
            background-image: -webkit-gradient(
                    linear,
                    left bottom,
                    left top,
                    color-stop(0.25, rgb(210, 244, 254)),
                    color-stop(1, rgb(149, 194, 253))
            );
            border: solid 1px rgba(0, 0, 0, 0.5);
            /* vendor rules */
            border-radius: 20px;
            /* vendor rules */
            box-shadow: inset 0 5px 5px rgba(255, 255, 255, 0.4), 0 1px 3px rgba(0, 0, 0, 0.2);
            /* vendor rules */
            box-sizing: border-box;
            clear: both;
            float: left;
            margin-bottom: 20px;
            padding: 8px 30px;
            position: relative;
            text-shadow: 0 1px 1px rgba(255, 255, 255, 0.7);
            width: auto;
            max-width: 100%;
            word-wrap: break-word;
        }

        .bubble:before, .bubble:after {
            border-radius: 20px / 10px;
            content: '';
            display: block;
            position: absolute;
        }

        .bubble:before {
            border: 10px solid transparent;
            border-bottom-color: rgba(0, 0, 0, 0.5);
            bottom: 0;
            left: -7px;
            z-index: -2;
        }

        .bubble:after {
            border: 8px solid transparent;
            border-bottom-color: #d2f4fe;
            bottom: 1px;
            left: -5px;
        }

        .bubble--alt {
            background-image: linear-gradient(bottom, rgb(172, 228, 75) 25%, rgb(122, 205, 71) 100%);
            background-image: -o-linear-gradient(bottom, rgb(172, 228, 75) 25%, rgb(122, 205, 71) 100%);
            background-image: -moz-linear-gradient(bottom, rgb(172, 228, 75) 25%, rgb(122, 205, 71) 100%);
            background-image: -webkit-linear-gradient(bottom, rgb(172, 228, 75) 25%, rgb(122, 205, 71) 100%);
            background-image: -ms-linear-gradient(bottom, rgb(172, 228, 75) 25%, rgb(122, 205, 71) 100%);
            background-image: -webkit-gradient(
                    linear,
                    left bottom,
                    left top,
                    color-stop(0.25, rgb(172, 228, 75)),
                    color-stop(1, rgb(122, 205, 71))
            );
            float: right;
        }

        .bubble--alt:before {
            border-bottom-color: rgba(0, 0, 0, 0.5);
            border-radius: 20px / 10px;
            left: auto;
            right: -7px;
        }

        .bubble--alt:after {
            border-bottom-color: #ace44b;
            border-radius: 20px / 10px;
            left: auto;
            right: -5px;
        }
    </style>
</head>
<body>
{{ ws_client() }}

<div id="test" style="height: 400px; border: 1px solid green;float: left;width: 70%"></div>

<div id="userList" style="float: right;border: 1px solid blue; height: 400px;width: 25%"></div>
<form method="post">
    <input type="text" id="messageBox">
    <button id="sendBtn">Send</button>
</form>
{% block javascript %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0-beta1/jquery.js"></script>
    <script src="https://raw.githubusercontent.com/mouse0270/bootstrap-notify/master/bootstrap-notify.min.js"></script>
    <script src="{{ asset('bundles/fosjsrouting/js/router.js') }}"></script>
    <script src="{{ path('fos_js_routing_js', {'callback': 'fos.Router.setData'}) }}"></script>

    <script>
        var url = "ws://{{ gos_web_socket_server_host }}:{{ gos_web_socket_server_port }}/FormEvents/web/app_dev.php/chat";
        //var url = "ws://localhost:80";
        var webSocket = WS.connect(url);
        webSocket.on("socket/connect", function (session) {
            //session is an Autobahn JS WAMP session.
            session.subscribe("/pm/public", function (uri, payload) {
                var currentUser = '{{ app.user.username }}';
                var message = "";
                if (payload.user == currentUser) {
                    message = "<div class='well text-right'>" +
                            "<span class='col-md-11'><small class='bubble bubble--alt'>" + payload.msg + "</small>" +
                            "</span></div>";
                } else {
                    message = "<div class='well text-left'>" +
                            "<span class='col-md-11'> <strong>" + payload.user + "</strong> : <small class='bubble'>" + payload.msg + "</small>" +
                            "</span></div>";
                }
                if (payload.type != "system") {
                    document.getElementById('test').innerHTML += message;
                }

                var userList = payload.userList || [];
                var list = "<ul class='list-group'>";
                console.log(payload.userList);
                userList.forEach(function (user) {
                    list += "<li class='list-group-item'>" + user + "</li>";
                });
                list += "</ul>";

                $("#userList").html(list);

            });


            $("#sendBtn").click(function (e) {
                e.preventDefault();
                session.publish("/pm/public", $.trim($('#messageBox').val()));
                $('#messageBox').val("");
            });

            console.log("Successfully Connected!");
        });

        webSocket.on("socket/disconnect", function (error) {
            //error provides us with some insight into the disconnection: error.reason and error.code

            console.log("Disconnected for " + error.reason + " with code " + error.code);
        });
    </script>
{% endblock %}
</body>
</html>